package com.flightapp.services;

import com.flightapp.dto.BookingRequest;
import com.flightapp.entities.Booking;
import com.flightapp.entities.FlightInventory;
import com.flightapp.entities.Passenger;
import com.flightapp.repositories.BookingRepository;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;
import java.util.List;
import java.util.UUID;
import java.util.stream.Collectors;

@Service
public class BookingService {
	@Autowired
    private final BookingRepository bookingRepo;
	@Autowired
    private final FlightService flightService;
    public BookingService(BookingRepository bookingRepo, FlightService flightService) {
        this.bookingRepo = bookingRepo;
        this.flightService = flightService;
    }
    public Booking book(Long flightId, BookingRequest req) {
        FlightInventory flight = flightService.findById(flightId);
        if (flight == null) throw new IllegalArgumentException("Invalid flight id");
        if (flight.getAvailableSeats() < req.getSeats()) throw new IllegalArgumentException("Not enough seats");

        List<Passenger> passengers = req.getPassengers().stream().map(p -> Passenger.builder()
                .name(p.getName())
                .age(p.getAge())
                .gender(p.getGender())
                .mealPref(p.getMealPref())
                .seatNumber(p.getSeatNumber())
                .build()).collect(Collectors.toList());
        String pnr = UUID.randomUUID().toString().substring(0,8).toUpperCase();
        Booking booking = Booking.builder()
                .pnr(pnr)
                .email(req.getEmail())
                .name(req.getName())
                .seatsBooked(req.getSeats())
                .bookedAt(LocalDateTime.now())
                .flight(flight)
                .passengers(passengers)
                .cancelled(false)
                .build();
        flight.setAvailableSeats(flight.getAvailableSeats() - req.getSeats());
        bookingRepo.save(booking);
        return booking;
    }
    public Booking findByPnr(String pnr) {
        return bookingRepo.findByPnr(pnr).orElse(null);
    }
    public List<Booking> history(String email) {
        return bookingRepo.findByEmail(email);
    }
    public Booking cancel(String pnr) {
        Booking b = findByPnr(pnr);
        if (b == null) throw new IllegalArgumentException("PNR not found");
        if (b.isCancelled()) throw new IllegalArgumentException("Already cancelled");
        LocalDateTime dep = b.getFlight().getDepartureTime();
        if (dep.isBefore(LocalDateTime.now().plusHours(24))) {
            throw new IllegalArgumentException("Cannot cancel within 24 hours of departure");
        }
        b.setCancelled(true);
        b.setCancelledAt(LocalDateTime.now());
        b.getFlight().setAvailableSeats(b.getFlight().getAvailableSeats() + b.getSeatsBooked());
        bookingRepo.save(b);
        return b;
    }
}

